// @ts-check
import flowRemoveTypes from "flow-remove-types";
import * as fs from "node:fs";
import { createRequire } from "node:module";
import * as path from "node:path";

function main() {
  const require = createRequire(import.meta.url);

  const flowOptions = { all: true, pretty: true };
  /** @type {{ encoding: "utf-8" }} */
  const fsOptions = { encoding: "utf-8" };
  /** @type {fs.NoParamCallback} */
  const rethrow = (err) => {
    if (err) {
      throw err;
    }
  };

  const assetsRegistry = path.dirname(
    require.resolve("@react-native/assets-registry/package.json")
  );

  for (const filename of ["path-support.js", "registry.js"]) {
    const p = path.join(assetsRegistry, filename);
    fs.readFile(p, fsOptions, (err, source) => {
      rethrow(err);
      const t = [
        `// THIS FILE WAS GENERATED BY '${path.basename(import.meta.url)}'`,
        "/* eslint-disable @typescript-eslint/ban-ts-comment */",
        "// @ts-nocheck",
        "// prettier-ignore",
        flowRemoveTypes(source, flowOptions).toString(),
      ].join("\n");
      fs.writeFile(path.join("src", "assets-registry", filename), t, rethrow);
    });
  }
}

main();
