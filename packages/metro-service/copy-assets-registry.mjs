// @ts-check
import flowRemoveTypes from "flow-remove-types";
import * as fs from "node:fs";
import { createRequire } from "node:module";
import * as path from "node:path";

function main() {
  const require = createRequire(import.meta.url);

  const flowOptions = { all: true, pretty: true };
  /** @type {{ encoding: "utf-8" }} */
  const fsOptions = { encoding: "utf-8" };
  /** @type {fs.NoParamCallback} */
  const rethrow = (err) => {
    if (err) {
      throw err;
    }
  };

  const assetsRegistry = path.dirname(
    require.resolve("@react-native/assets-registry/package.json")
  );

  const assetsRegistryDir = path.join("src", "assets-registry");
  fs.readdir(assetsRegistryDir, (err, files) => {
    rethrow(err);

    for (const filename of files) {
      if (!filename.endsWith(".js")) {
        continue;
      }

      const p = path.join(assetsRegistry, filename);
      fs.readFile(p, fsOptions, (err, source) => {
        rethrow(err);

        const t = [
          `// THIS FILE WAS GENERATED BY '${path.basename(import.meta.url)}'`,
          "/* eslint-disable @typescript-eslint/ban-ts-comment */",
          "// @ts-nocheck",
          flowRemoveTypes(source, flowOptions).toString(),
        ].join("\n");

        const dest = path.join(assetsRegistryDir, filename);
        fs.readFile(dest, fsOptions, (err, current) => {
          rethrow(err);
          if (t !== current) {
            fs.writeFile(dest, t, rethrow);
            console.log(`${dest}: updated`);
          }
        });
      });
    }
  });
}

main();
