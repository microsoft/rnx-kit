/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@rnx-kit/yarn-plugin-external-workspaces",
factory: function (require) {
"use strict";var plugin=(()=>{var ye=Object.create;var w=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var _e=Object.getOwnPropertyNames;var ve=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var a=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var d=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),be=(e,t)=>{for(var n in t)w(e,n,{get:t[n],enumerable:!0})},U=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of _e(t))!Oe.call(e,r)&&r!==n&&w(e,r,{get:()=>t[r],enumerable:!(o=he(t,r))||o.enumerable});return e};var $=(e,t,n)=>(n=e!=null?ye(ve(e)):{},U(t||!e||!e.__esModule?w(n,"default",{value:e,enumerable:!0}):n,e)),ke=e=>U(w({},"__esModule",{value:!0}),e);var j=d(m=>{"use strict";var N=m&&m.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(m,"__esModule",{value:!0});m.enableLogging=Fe;m.trace=De;var A=N(a("fs")),we=N(a("path")),V=we.default.join(process.cwd(),"plugin-external-workspaces.log"),je=performance.now(),K="console",O;function Fe(e){O=e??V,O!==K&&A.default.writeFileSync(O,"")}function De(e){if(O){let t=(performance.now()-je).toFixed(2);O===K?console.log(`[${t}ms] ${e}`):A.default.appendFile(V,`[${t}ms] ${e}
`,()=>null)}}});var D=d(c=>{"use strict";var Y=c&&c.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(c,"__esModule",{value:!0});c.parseJsonPath=B;c.getDepsFromJson=H;c.createFinderFromJson=G;c.createFinderFromJs=z;c.loadConfigFile=Ce;var R=Y(a("fs")),y=Y(a("path")),F=j(),X=".json",Ee=e=>null;function B(e){let t=e.indexOf(X);if(t>0){let n=t+X.length,o=e.slice(0,n),r=e.length>n+1?e.slice(n+1):"";return{jsonPath:o,keysPath:r}}return{}}function H(e,t){let n=t?t.split("/"):[],o=e;for(let r of n)if(o=o[r],!o)return;return o}function G(e,t){if(R.default.existsSync(e)){let n=H(JSON.parse(R.default.readFileSync(e,"utf8")),t);if(n)return(0,F.trace)(`Loaded the finder from the json file ${e}`),o=>n[o]??null}return Ee}function z(e){let t=a(e);if(!t)throw new Error(`Unable to load config from ${e}`);return(0,F.trace)(`Creating a finder from: ${e}`),t.default}function Se(e,t){let n=new Map;return o=>{if(n.has(o))return n.get(o)??null;let r=e(o),i=r?{...r}:null;return i&&i.path&&(y.default.isAbsolute(i.path)||(i.path=y.default.resolve(t,i.path)),R.default.existsSync(y.default.join(i.path,"package.json"))?(0,F.trace)(`finder: ${o} found at ${i.path}`):((0,F.trace)(`finder: ${o} not found at ${i.path}`),i.path=void 0)),n.set(o,i),i}}function Ce(e){e=y.default.resolve(process.cwd(),e);let{jsonPath:t,keysPath:n}=B(e),o=y.default.dirname(t||e),r;if(t)r=G(t,n);else{let i=y.default.extname(e).toLowerCase();(i===".js"||i===".cjs")&&(r=z(e))}if(!r)throw new Error(`Invalid external workspace config path: ${e}. Supported types are .json, .js, and .cjs`);return Se(r,o)}});var x=d(L=>{"use strict";Object.defineProperty(L,"__esModule",{value:!0});L.getConfigurationOptions=$e;var Pe={configPath:{configKey:"externalWorkspacesConfig",description:"Path to the external dependencies provider, either './filename.json/key1/key2' or './src/lookup.js|.cjs' ",settingType:"string",defaultValue:"./package.json/external-workspaces"},enableLogging:{configKey:"externalWorkspacesEnableLogging",description:"Turn on debug logging and log output to plugin-external-workspaces.log",settingType:"boolean",defaultValue:!1},outputWorkspaces:{configKey:"externalWorkspacesOutputWorkspaces",description:"Output the workspaces for this repo to a .json file, suitable for consumption by the plugin in another repo",settingType:"string",defaultValue:""}};function $e(){return Pe}});var ne=d(b=>{"use strict";var te=b&&b.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(b,"__esModule",{value:!0});b.writeOutWorkspaces=xe;var M=te(a("fs")),q=te(a("path")),Q=D(),Z=j();function ee(e,t){let n=Object.entries(e).map(([o,r])=>({name:o,...r}));return t?n.sort((o,r)=>o.name.localeCompare(r.name)):n}function Re(e,t){for(let{name:n,...o}of e)t[n]=o}function Le(e,t){return e.length===t.length&&e.every((n,o)=>n.name===t[o].name&&n.path===t[o].path&&n.version===t[o].version)}function xe(e,t){let{jsonPath:n,keysPath:o}=(0,Q.parseJsonPath)(t);if(!n)throw new Error(`Invalid output path: ${t}`);let r=q.default.dirname(q.default.resolve(n)),i=ee(e,!0);for(let P of i)P.path&&(P.path=q.default.relative(r,P.path));let s=M.default.existsSync(n)?JSON.parse(M.default.readFileSync(n,"utf8")):{},k=(0,Q.getDepsFromJson)(s,o);if(k&&Le(i,ee(k))){(0,Z.trace)(`No changes to ${n}, skipping update`);return}let g=o?o.split("/"):[],I=g.length>0?s:{},_=I,v=g.shift();for(;v;)(!_[v]||g.length===0)&&(_[v]={}),_=_[v],v=g.shift();Re(i,_);let me=JSON.stringify(I,null,2);M.default.writeFileSync(n,me),(0,Z.trace)(`Updated ${n}`)}});var se=d(h=>{"use strict";var re=h&&h.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(h,"__esModule",{value:!0});h.getYarnOption=ie;h.getSettingsFromRepo=Je;var Me=a("child_process"),qe=re(a("fs")),oe=re(a("path")),Te=D(),We=x();async function ie(e,t=process.cwd()){return new Promise(n=>{(0,Me.exec)(`yarn config get ${e}`,{cwd:t},(o,r,i)=>{n(o||i?void 0:r.trim())})})}var T;async function Je(e){if(T)return T;if(!e)throw new Error("No workspace root specified");if(!qe.default.existsSync(oe.default.join(e,"yarn.lock")))throw new Error("External workspaces is only supported in yarn workspaces");let n=(0,We.getConfigurationOptions)().configPath,o=await ie(n.configKey,e),r=oe.default.resolve(e,o??n.defaultValue);return T={configPath:r,enableLogging:!1,outputWorkspaces:"",finder:(0,Te.loadConfigFile)(r)}}});var E=d(u=>{"use strict";Object.defineProperty(u,"__esModule",{value:!0});u.getSettingsFromRepo=u.writeOutWorkspaces=u.getConfigurationOptions=u.trace=u.enableLogging=u.loadConfigFile=void 0;var Ie=D();Object.defineProperty(u,"loadConfigFile",{enumerable:!0,get:function(){return Ie.loadConfigFile}});var ae=j();Object.defineProperty(u,"enableLogging",{enumerable:!0,get:function(){return ae.enableLogging}});Object.defineProperty(u,"trace",{enumerable:!0,get:function(){return ae.trace}});var Ue=x();Object.defineProperty(u,"getConfigurationOptions",{enumerable:!0,get:function(){return Ue.getConfigurationOptions}});var Ne=ne();Object.defineProperty(u,"writeOutWorkspaces",{enumerable:!0,get:function(){return Ne.writeOutWorkspaces}});var Ae=se();Object.defineProperty(u,"getSettingsFromRepo",{enumerable:!0,get:function(){return Ae.getSettingsFromRepo}})});var He={};be(He,{default:()=>Be});var p=$(E()),J=a("@yarnpkg/core");function Ve(e){switch(e){case"string":return J.SettingsType.STRING;case"boolean":return J.SettingsType.BOOLEAN;default:throw new Error(`Unknown type ${e}`)}}function ce(){let e=(0,p.getConfigurationOptions)();return Object.fromEntries(Object.entries(e).map(([t,n])=>[n.configKey,{description:n.description,type:Ve(n.settingType),default:n.defaultValue}]))}function ue(e,t){let n=e.get(t.configKey);return n&&typeof n=="string"?n:t.defaultValue}function Ke(e,t){let n=e.get(t.configKey);return n!==void 0?!!n:t.defaultValue}var W;function S(e){if(!W){let t=(0,p.getConfigurationOptions)(),n=e.configuration,o=ue(n,t.configPath),r=Ke(n,t.enableLogging),i=ue(n,t.outputWorkspaces),s=(0,p.loadConfigFile)(o);r&&(0,p.enableLogging)(),W={configPath:o,enableLogging:r,outputWorkspaces:i,finder:s}}return W}var le=$(E()),fe=a("@yarnpkg/core");function pe(e,t){let{outputWorkspaces:n}=S(e);if(n&&n.indexOf(".json")!==-1){let o={};e.workspacesByIdent.forEach(r=>{let{name:i,version:s,private:k}=r.manifest;if(i&&s&&!k){let g=fe.structUtils.stringifyIdent(i);o[g]={version:s,path:r.cwd}}}),(0,le.writeOutWorkspaces)(o,n)}}var l=$(E()),de=a("@yarnpkg/core");var{makeDescriptor:ge,makeLocator:Xe,stringifyIdent:f}=de.structUtils,C=class e{constructor(){this.finder=void 0;this.report=void 0}static{this.protocol="external:"}getFinder(t){return this.finder||(this.finder=S(t.project).finder),this.finder}getResolutionDependencies(t,n){return(0,l.trace)(`UNEXPECTED: getResolutionDependencies called for ${f(t)}`),{}}supportsDescriptor(t,n){let o=t.range.startsWith(e.protocol);return(0,l.trace)(`supportsDescriptor called for ${f(t)} : ${t.range}`),o}supportsLocator(t,n){let o=t.reference.startsWith(e.protocol);return(0,l.trace)(`UNEXPECTED: supportsLocator called for ${f(t)}`),o}shouldPersistResolution(t,n){return!1}bindDescriptor(t,n,o){let r=this.getFinder(o),i=f(t),s=r(i);if(!s)throw Error(`Unknown external workspace "${i}:${e.protocol}" included by "${f(n)}"`);return s.path?((0,l.trace)(`bindDescriptor transforming ${i} to "portal:${s.path}"`),ge(t,`portal:${s.path}`)):((0,l.trace)(`bindDescriptor transforming ${i} to "npm:${s.version}"`),ge(t,`npm:${s.version}`))}async getCandidates(t,n,o){return(0,l.trace)(`UNEXPECTED: getCandidates called for ${f(t)}`),[Xe(t,t.range)]}async getSatisfying(t,n,o,r){this.report??=r.report,(0,l.trace)(`UNEXPECTEDP: getSatisfying called for ${f(t)}`);let[i]=await this.getCandidates(t,n,r);return{locators:o.filter(s=>s.locatorHash===i.locatorHash),sorted:!1}}async resolve(t,n){return this.report??=n.report,(0,l.trace)(`UNEXPECTED: Resolving external locator ${f(t)}`),{...t,name:t.name,version:"0.0.0",languageName:"unknown",conditions:null}}};var Ye={configuration:ce(),resolvers:[C],hooks:{afterAllInstalled:pe}},Be=Ye;return ke(He);})();
return plugin;
}
};
//# sourceMappingURL=external-workspaces.cjs.map
